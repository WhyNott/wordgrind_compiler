<html>
  <head>
    <script src="js_assets/runtime.js"></script>
    <script src="compiled.js"></script>
    <script src="js_assets/cytoscape.min.js"></script>
    <script src="js_assets/dagre.js"></script>
    <script src="js_assets/cytoscape-dagre.js"></script>
  </head>
  <body>
    <div style="display: flex; justify-content: space-evenly">
    <div>
        <input type="text" id="input" style="width: 20em;"> <input type="submit" onclick="run_query()" value="Run query"></br>
        </textarea>
         <div id="output" style="width: 30em;border-width: 1px;border-style: solid;min-height: 50rem; padding-left: 0.5em;margin-top: 1rem;"></div>
         
        <script>
          function run_query(){
              const input = document.getElementById("input");
              const output = document.getElementById("output");

              const out_pipe = (str) => {
                  let p = document.createElement("p");
                  p.appendChild(document.createTextNode(str + "\n"));
                  output.appendChild(p);
              };
              dc.clear();
              try {
                  query(input.value, out_pipe);
                  dc.set_step_to(0);
              } catch (err) {
                  out_pipe(err.toString());
              }
          }

          
          window.addEventListener('DOMContentLoaded', function(){
              const picker = document.getElementById("num_picker");
              const label = document.getElementById("label_display");
              dc = {
                  current_step: 0,
                  steps: [],

                  clear(){
                      this.steps = [];
                      this.current_step = 0;
                      picker.disabled=false;
                      picker.value = 0;
                      label.innerText = "...";
                      reset_globals();
                      
                  },
                  add_new_step(label){
                      this.steps.push({
                          label: label,
                          nodes: produce_nodes()
                      });
                      picker.max = this.steps.length;
                  },
                  
                  set_step_to(num){
                      this.current_step = num;
                      this.cy.elements().remove();
                      this.cy.add(this.steps[num].nodes);
                      label.innerText = this.steps[num].label;
                      this.cy.layout({ name: 'dagre'}).run();
                  },
                  
                  step_forward(){
                      if (this.current_step < this.steps.length)
                          this.set_step_to(this.current_step + 1);
                  },
                  
                  step_backward(){
                      if (this.current_step > 0)
                          this.set_step_to(this.current_step - 1);
                  },
                  
                  cy : cytoscape({
                      container: document.getElementById('cy'),
                      
                      boxSelectionEnabled: false,
                      autounselectify: true,
                      
                      layout: {
                          name: 'dagre'
                      },
                  
                      style: [
                          {
                              selector: 'node',
                              style: {
                                  'background-color': '#11479e',
                                  'border-style': 'solid',
                                  'border-color': '#454049'
                              }
                          },
                  
                          {
                              "selector": "node[label]",
                              "style": {
                                  "label": "data(label)",
                                  "color": "#fff",
                                  "text-outline-color": "#7CC5A7",
                                  "text-outline-width": 2,
                                  "text-valign": "center",
                                  "text-halign": "center"
                              }
                          },
                          
                          {
                              "selector": "edge[label]",
                              "style": {
                                  "label": "data(label)",
                                  "width": 3,
                                  "color": "#fff",
                                  "text-outline-color": "#7CC5A7",
                                  "text-outline-width": 2,
                                  "text-valign": "center",
                                  "text-halign": "center"
                              }
                          },
                  
                          {
                              "selector": '.variable',
                              "style": {
                                  'border-style': 'solid',
                                  'border-width' : '1',
                                  'background-color': '#A0D3B0'
                              }
                          },

                  
                          {
                              "selector": '.atom',
                              "style": {
                                  'border-style': 'solid',
                                  'border-width' : '1',
                                  'background-color': '#F2E89E'
                              }
                          },
                  
                          {
                              "selector": '.structured',
                              "style": {
                                  'border-style': 'solid',
                                  'border-width' : '1',
                                  'background-color': '#C6B476'
                              }
                          },

                          {
                              selector: '.copy',
                              "style" :{
                                  'border-width' : '2',
                                  'border-color': '#5EAAEF'
                              }
                              
                          },

                          {
                              selector: '.model',
                              style :{
                                  'border-width' : '2',
                                  'border-color': '#CE80A8'
                              }
                              
                          },
                          
                          {
                              selector: 'edge',
                              style: {
                                  'width': 4,
                                  'target-arrow-shape': 'triangle',
                                  'line-color': '#454049',
                                  'target-arrow-color': '#454049',
                                  'curve-style': 'bezier'
                              }
                          },

                          {
                              "selector": '.backup',
                              "style": {
                                  'width': 2,
                                  'line-color': '#CE80A8',
                                  'line-style': 'dashed',
                                  'target-arrow-color': '#CE80A8'
                              }
                          },

                          
                      ],
                      elements: produce_nodes()
                  
                  }),
                  
              };
              picker.addEventListener('input', (n) => dc.set_step_to(Number(n.data)));
              
          });

          
          
          
        </script>
    </div>
    <div style="height: 50rem; width: 50vw;">
      <input type="number" disabled="true" name="quantity" min="0" max="0" value="0" id="num_picker">
      <h3 style="display: inline-block;padding-left: 1rem;" id="label_display">...</h3>
      <div style=" border-style: solid; border-width: thin; height: 100%" id="cy"> </div>
    </div>
    </div>
    
  </body>
  
</html>
